/* DO NOT EDIT: File is auto-generated */
package <%= repository.imit.entity_package %>;

import org.realityforge.replicant.client.transport.SubscriptionEntry;

@javax.annotation.Generated( "Domgen" )
@java.lang.SuppressWarnings( { "UnusedDeclaration", "JavaDoc" } )
public class <%= repository.imit.subscription_manager_impl_name %>
  extends org.realityforge.replicant.client.transport.AbstractSubscriptionManager<<%= repository.imit.qualified_graph_enum_name %>>
  implements <%= repository.imit.qualified_subscription_manager_name %>
{
  private static final java.util.logging.Logger LOG = java.util.logging.Logger.getLogger( <%= repository.imit.subscription_manager_impl_name %>.class.getName() );

  private final <%= repository.imit.qualified_client_session_context_name %> _context;

  public <%= repository.imit.subscription_manager_impl_name %>( final <%= repository.imit.qualified_client_session_context_name %> context )
  {
    _context = context;
  }
<%
  repository.imit.graphs.each do |graph|
  param = ''
  param_value = ''
  param_early_value = ''
  param_cache_value = ''
  subscribe_method = 'Type'
  if graph.instance_root?
    # Names are fully qualified so take any random data module
    entity = repository.entity_by_name(graph.instance_root)
    type = entity.primary_key.imit.primitive_java_type
    varname = "#{Domgen::Naming.camelize(entity.name)}#{entity.primary_key.name}"
    param = "final #{type} #{varname}"
    param_value = ", #{varname}"
    param_early_value = varname
    subscribe_method = 'Instance'
  elsif graph.cacheable?
    param_cache_value = 'eTag, cacheCurrentAction, '
  end
  filter_param = ''
  update_param = param.dup
  update_param_early_value = param_early_value.dup
  if graph.filter_parameter
    p = graph.filter_parameter
    java_type = "#{nullability_annotation(p.nullable?)} #{Domgen::Java.java_type(p, :imit, :default)}"
    update_param = "#{update_param}, " if update_param.size > 0
    filter_param = "#{java_type} filter"
    update_param = "#{update_param}#{filter_param}"
    update_param_early_value = "#{update_param_early_value}, " if update_param_early_value.size > 0
    update_param_early_value = "#{update_param_early_value}filter"
  end
  suffix = "@javax.annotation.Nullable final Runnable action"
%>
  @Override
  public boolean isSubscribedTo<%= graph.name %>(<%= param %>)
  {
    return null != find<%= subscribe_method %>GraphSubscription( <%= repository.imit.qualified_graph_enum_name %>.<%= Domgen::Naming.uppercase_constantize(graph.name) %><%= param_value %> );
  }

<% if graph.instance_root? -%>
  @Override
  public java.util.Map<Object, SubscriptionEntry<<%= repository.imit.qualified_graph_enum_name %>>> get<%= graph.name %>Subscriptions()
  {
    final java.util.Map<Object, SubscriptionEntry<<%= repository.imit.qualified_graph_enum_name %>>> subscriptions =
      getInstanceSubscriptions().get( <%= repository.imit.qualified_graph_enum_name %>.<%= Domgen::Naming.uppercase_constantize(graph.name) %> );
    if ( null != subscriptions )
    {
      return java.util.Collections.unmodifiableMap( subscriptions );
    }
    else
    {
      return java.util.Collections.emptyMap();
    }
  }
<% end -%>

  @Override
  public void subscribeTo<%= graph.name %>(<%= update_param %><%= update_param.size > 0 ? ", #{suffix}" : suffix %>)
  {
    final SubscriptionEntry<<%= repository.imit.qualified_graph_enum_name %>> entry =
      subscribeTo<%= subscribe_method %>Graph( <%= repository.imit.qualified_graph_enum_name %>.<%= Domgen::Naming.uppercase_constantize(graph.name) %><%= param_value %> );
    if( null != entry )
    {
      final Runnable runnable = new Runnable()
      {
        @Override
        public void run()
        {
          entry.markAsPresent();
          if( null != action )
          {
            action.run();
          }
          LOG.info( "subscribeTo<%= graph.name %>(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) completed." );
        }
      };
<% if graph.cacheable? -%>
      final org.realityforge.replicant.client.transport.CacheEntry cacheEntry = _context.getCacheService().lookup( <%= repository.imit.qualified_graph_enum_name %>.<%= Domgen::Naming.uppercase_constantize(graph.name) %>.name() );
      final String eTag = null != cacheEntry ? cacheEntry.getETag() : null;
      final String content = null != cacheEntry ? cacheEntry.getContent() : null;
      if( null != content )
      {
        LOG.info( "Found locally cached data for graph <%= graph.name %> with etag " + eTag + "." );
      }
      final Runnable cacheCurrentAction = new Runnable()
      {
        public void run()
        {
          assert null != content;
          LOG.info( "Loading cached data for graph <%= graph.name %> with etag " + eTag );
          //TODO: Figure out how to make the bulkLoad configurable
          _context.loadCachedContent( content, runnable, true );
          LOG.info( "subscribeTo<%= graph.name %>(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) completed." );
        }
      };
<% end -%>
      LOG.info( "subscribeTo<%= graph.name %>(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) requested." );
      _context.remoteSubscribeTo<%= graph.name %>( <%= param_cache_value %><%= update_param_early_value %><%= update_param_early_value.size > 0 ? ', ' : '' %>runnable );
    }
<% if graph.filter_parameter -%>
    else
    {
      update<%= graph.name %>Subscription(<%= update_param_early_value %><%= update_param_early_value.size > 0 ? ', ' : '' %>action);
    }
<% end -%>
  }

<% if graph.filter_parameter %>
  public void update<%= graph.name %>Subscription(<%= update_param %><%= update_param.size > 0 ? ", #{suffix}" : suffix %>)
  {
    final SubscriptionEntry<<%= repository.imit.qualified_graph_enum_name %>> entry =
      find<%= subscribe_method %>GraphSubscription( <%= repository.imit.qualified_graph_enum_name %>.<%= Domgen::Naming.uppercase_constantize(graph.name) %><%= param_value %> );
    if( null != entry )
    {
      final Runnable runnable = new Runnable()
      {
        @Override
        public void run()
        {
          entry.setSubscriptionUpdateInProgress( false );
          if( null != action )
          {
            action.run();
          }
          LOG.info( "update<%= graph.name %>Subscription(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) completed." );
        }
      };
      LOG.info( "update<%= graph.name %>Subscription(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) requested." );
      entry.setSubscriptionData( filter );
      entry.setSubscriptionUpdateInProgress( true );
      _context.remoteUpdate<%= graph.name %>Subscription( <%= update_param_early_value %><%= update_param_early_value.size > 0 ? ', ' : '' %>runnable );
    }
  }
<% end %>

  @Override
  public void unsubscribeFrom<%= graph.name %>(<%= param %><%= param.size > 0 ? ", #{suffix}" : suffix %>)
  {
    final SubscriptionEntry<<%= repository.imit.qualified_graph_enum_name %>> entry =
      unsubscribeFrom<%= subscribe_method %>Graph( <%= repository.imit.qualified_graph_enum_name %>.<%= Domgen::Naming.uppercase_constantize(graph.name) %><%= param_value %> );
    if( null != entry )
    {
      LOG.info( "unsubscribeFrom<%= graph.name %>(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) requested." );
      entry.markDeregisterInProgress();
      _context.remoteUnsubscribeFrom<%= graph.name %>( <%= param_early_value %><%= param_early_value.size > 0 ? ', ' : '' %>new Runnable()
      {
        @Override
        public void run()
        {
          entry.markAsDeregistered();
          if( null != action )
          {
            action.run();
          }
          LOG.info( "unsubscribeFrom<%= graph.name %>(<%= graph.instance_root? ? "\" + #{varname} + \"" : "" %>) completed." );
        }
      } );
    }
  }
<% end %>
}
